name: Test Secrets
on: 
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test AWS Credentials
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AMAZON_Q_API_KEY: ${{ secrets.AMAZON_Q_API_KEY }}
      run: |
        echo "üîç Testing GitHub Secrets..."
        echo ""
        
        # Test AWS Access Key
        if [ -n "$AWS_ACCESS_KEY_ID" ]; then
          echo "‚úÖ AWS_ACCESS_KEY_ID: Set (length: ${#AWS_ACCESS_KEY_ID})"
        else
          echo "‚ùå AWS_ACCESS_KEY_ID: Missing"
          exit 1
        fi
        
        # Test AWS Secret Key  
        if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
          echo "‚úÖ AWS_SECRET_ACCESS_KEY: Set (length: ${#AWS_SECRET_ACCESS_KEY})"
        else
          echo "‚ùå AWS_SECRET_ACCESS_KEY: Missing"
          exit 1
        fi
        
        # Test Amazon Q API Key
        if [ -n "$AMAZON_Q_API_KEY" ]; then
          echo "‚úÖ AMAZON_Q_API_KEY: Set (length: ${#AMAZON_Q_API_KEY})"
        else
          echo "‚ö†Ô∏è  AMAZON_Q_API_KEY: Missing (will use simulation)"
        fi
        
        echo ""
        echo "üéâ Secrets test completed successfully!"
    
    - name: Test AWS CLI Access
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: us-west-2
      run: |
        echo "üîß Testing AWS CLI access..."
        
        # Install AWS CLI
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
        unzip awscliv2.zip
        sudo ./aws/install
        
        # Test AWS access
        aws sts get-caller-identity || {
          echo "‚ùå AWS credentials invalid or insufficient permissions"
          exit 1
        }
        
        echo "‚úÖ AWS CLI access verified!"
    
    - name: Validate Project Structure
      run: |
        echo "üìÅ Validating project structure..."
        
        # Check required directories
        required_dirs=(
          "services/api-gateway"
          "services/code-analysis" 
          "services/infrastructure-generation"
          "services/deployment"
          "infrastructure"
          ".github/workflows"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "‚úÖ $dir: Found"
          else
            echo "‚ùå $dir: Missing"
            exit 1
          fi
        done
        
        # Check required files
        required_files=(
          "docker-compose.yml"
          "docker-compose.lite.yml"
          "deploy-minimal.sh"
          "README.md"
          "infrastructure/minimal.tf"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file: Found"
          else
            echo "‚ùå $file: Missing"
            exit 1
          fi
        done
        
        echo "üéâ Project structure validation passed!"
    
    - name: Test Docker Builds
      run: |
        echo "üê≥ Testing Docker builds..."
        
        # Test API Gateway build
        cd services/api-gateway
        docker build -t test-api-gateway . || {
          echo "‚ùå API Gateway Docker build failed"
          exit 1
        }
        echo "‚úÖ API Gateway: Docker build successful"
        cd ../..
        
        # Test Code Analysis build  
        cd services/code-analysis
        docker build -t test-code-analysis . || {
          echo "‚ùå Code Analysis Docker build failed"
          exit 1
        }
        echo "‚úÖ Code Analysis: Docker build successful"
        cd ../..
        
        echo "üéâ Docker builds completed successfully!"
    
    - name: Summary
      run: |
        echo ""
        echo "üéØ AutoStack Setup Test Results:"
        echo "================================"
        echo "‚úÖ GitHub Secrets configured"
        echo "‚úÖ AWS credentials valid"
        echo "‚úÖ Project structure complete"
        echo "‚úÖ Docker builds working"
        echo ""
        echo "üöÄ AutoStack is ready for deployment!"
        echo "üí° Next step: Run './deploy-minimal.sh' to deploy"